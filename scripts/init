#!/bin/bash

function generate_file() {
  local filename scripts shebang comment answer
  shebang='#!'$(which bash)'\n'
  comment="### do not edit this file \n### it was generated via the $(realpath "$0") script\n\n"
  scripts=("${@:2}")
  filename="$1"

  touch "$filename"

  {
    echo -e "$shebang"
    echo -e "$comment"
  } >"$filename"

  for i in "${scripts[@]}"; do
    {
      echo "### ./${i}"
      tail -n +2 "$i"
      echo -e "### eo ./${i}\n"
    } >>"$filename"
  done
}

out="./out"
if [ ! -e "$out" ]; then
  mkdir "$out"
fi

bashrc="${out}/.bashrc"
bash_profile="${out}/.bash_profile"
scripts_bashrc=(
  "./bash/rc.bash"
  "./bash/history.bash"
  "./bash/ps1.bash"
  "./bash/aliases.bash"
  "./bash/sudo.bash"
  "./bash/xbps.bash"
  "./bash/runit.bash"
  "./bash/git.bash"
  "./bash/webdev.bash"
  "./bash/qmk.bash"
)
scripts_bash_profile=(
  "./bash/profile.bash"
  "./bash/webcam.bash"
)

generate_file "$bashrc" "${scripts_bashrc[@]}"
generate_file "$bash_profile" "${scripts_bash_profile[@]}"

if [ -e "${HOME}/.bash_profile" ] || [ -e "${HOME}/.bashrc" ]; then

  _date=$"(date +"%Y%m%d%H%M")"
  read -p "Override .bashrc and .bash_profile? (bkps in ...${_date}) [Y/n] " answer
  if [ -n "$answer" ] && [ "$answer" != "y" ]; then
    echo Aborting.
    exit 0
  fi

  cp "${HOME}/.bashrc" "${HOME}/.bashrc.${_date}"
  cp "${HOME}/.bash_profile" "${HOME}/.bash_profile.${_date}"

  cp "$bashrc" "${HOME}/.bashrc"
  cp "$bash_profile" "${HOME}/.bash_profile"

  # shellcheck disable=1091
  source "${HOME}/.bash_profile"
  # shellcheck disable=1091
  source "${HOME}/.bashrc"
  echo Done.
fi
